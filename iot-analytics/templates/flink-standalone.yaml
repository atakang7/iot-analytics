{{- if .Values.flink.enabled }}
# ============================================================================
# FLINK STANDALONE DEPLOYMENT
# ============================================================================

# ----------------------------------------------------------------------------
# STORAGE
# ----------------------------------------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: flink-pvc
  labels:
    app: flink
spec:
  accessModes:
    - {{ .Values.flink.storage.accessMode }}
  resources:
    requests:
      storage: {{ .Values.flink.storage.size }}

---
# ----------------------------------------------------------------------------
# FLINK CONFIGURATION
# ----------------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-config
  labels:
    app: flink
data:
  flink-conf.yaml: |+
    jobmanager.rpc.address: flink-jobmanager
    jobmanager.rpc.port: 6123
    taskmanager.rpc.port: 6122
    blob.server.port: 6124
    rest.address: 0.0.0.0
    rest.bind-address: 0.0.0.0
    
    taskmanager.numberOfTaskSlots: {{ .Values.flink.taskmanager.slots }}
    parallelism.default: {{ .Values.flink.config.parallelism }}
    
    jobmanager.memory.process.size: {{ .Values.flink.jobmanager.memory }}
    taskmanager.memory.process.size: {{ .Values.flink.taskmanager.memory }}
    
    state.backend: {{ .Values.flink.config.stateBackend }}
    state.checkpoint-storage: filesystem
    state.checkpoints.dir: file:///opt/flink/recovery/checkpoints
    state.savepoints.dir: file:///opt/flink/recovery/savepoints
    {{- if .Values.flink.config.checkpointing.enabled }}
    execution.checkpointing.interval: {{ .Values.flink.config.checkpointing.interval }}
    {{- end }}

---
# ----------------------------------------------------------------------------
# JOBMANAGER DEPLOYMENT
# ----------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-jobmanager
  labels:
    app: flink
    component: jobmanager
spec:
  replicas: {{ .Values.flink.jobmanager.replicas }}
  selector:
    matchLabels:
      app: flink
      component: jobmanager
  template:
    metadata:
      labels:
        app: flink
        component: jobmanager
    spec:
      initContainers:
      - name: init-config
        image: busybox
        command: ['/bin/sh', '-c']
        args:
          - |
            mkdir -p /conf
            cp -R /config-src/* /conf || true
        securityContext:
          runAsUser: 1001970000
        volumeMounts:
        - name: config-src-volume
          mountPath: /config-src
        - name: conf-volume
          mountPath: /conf

      - name: init-connectors
        image: {{ .Values.flink.image }}
        command: ['/bin/sh', '-c']
        args:
          - |
            echo LIB; ls -la /opt/flink/lib || true
            echo COPY; cp -R /opt/flink/lib/* /connectors || true
            echo POST COPY; ls -la /connectors || true
            {{- range .Values.flink.connectors }}
            url="{{ . }}"
            name="$(basename $url)"
            echo "Downloading $url -> /connectors/$name"
            tries=0
            until [ $tries -ge 5 ]; do
              if command -v wget >/dev/null 2>&1; then
                wget -q -O /connectors/"$name" "$url" && break || true
              elif command -v curl >/dev/null 2>&1; then
                curl -fsSL -o /connectors/"$name" "$url" && break || true
              else
                echo "No downloader (wget/curl) available"
                break
              fi
              tries=$((tries+1))
              sleep 1
            done
            if [ -s /connectors/"$name" ]; then
              echo "Downloaded $name"
            else
              echo "Failed to download $url"
            fi
            {{- end }}
            echo FINAL; ls -la /connectors || true
            sleep 1
        securityContext:
          runAsUser: 1001970000
        volumeMounts:
        - name: connectors-volume
          mountPath: /connectors

      containers:
      - name: jobmanager
        image: {{ .Values.flink.image }}
        command: ["/bin/bash", "-c"]
        args:
          - |
            /docker-entrypoint.sh jobmanager
        ports:
        - containerPort: 8081
          name: rest
        - containerPort: 6123
          name: rpc
        - containerPort: 6124
          name: blob
        env:
        - name: JOB_MANAGER_RPC_ADDRESS
          value: flink-jobmanager
        resources:
          requests:
            memory: {{ .Values.flink.jobmanager.resources.requests.memory | quote }}
            cpu: {{ .Values.flink.jobmanager.resources.requests.cpu | quote }}
          limits:
            memory: {{ .Values.flink.jobmanager.resources.limits.memory | quote }}
            cpu: {{ .Values.flink.jobmanager.resources.limits.cpu | quote }}
        volumeMounts:
        - name: conf-volume
          mountPath: /opt/flink/conf
        - name: recovery-volume
          mountPath: /opt/flink/recovery
        - name: connectors-volume
          mountPath: /opt/flink/lib
      volumes:
      - name: config-volume
        configMap:
          name: flink-config
          items:
          - key: flink-conf.yaml
            path: flink-conf.yaml
      - name: config-src-volume
        configMap:
          name: flink-config
      - name: conf-volume
        emptyDir: {}
      - name: recovery-volume
        persistentVolumeClaim:
          claimName: flink-pvc
      - name: connectors-volume
        emptyDir: {}

---
# ----------------------------------------------------------------------------
# JOBMANAGER SERVICE
# ----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: flink-jobmanager
  labels:
    app: flink
spec:
  type: ClusterIP
  ports:
  - name: rpc
    port: 6123
  - name: blob
    port: 6124
  - name: ui
    port: 8081
  selector:
    app: flink
    component: jobmanager

---
# ----------------------------------------------------------------------------
# TASKMANAGER DEPLOYMENT
# ----------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-taskmanager
  labels:
    app: flink
    component: taskmanager
spec:
  replicas: {{ .Values.flink.taskmanager.replicas }}
  selector:
    matchLabels:
      app: flink
      component: taskmanager
  template:
    metadata:
      labels:
        app: flink
        component: taskmanager
    spec:
      initContainers:
      - name: init-config
        image: busybox
        command: ['/bin/sh', '-c']
        args:
          - |
            mkdir -p /conf
            cp -R /config-src/* /conf || true
        securityContext:
          runAsUser: 1001970000
        volumeMounts:
        - name: config-src-volume
          mountPath: /config-src
        - name: conf-volume
          mountPath: /conf

      - name: init-connectors
        image: {{ .Values.flink.image }}
        command: ['/bin/sh', '-c']
        args:
          - |
            echo LIB; ls -la /opt/flink/lib || true
            echo COPY; cp -R /opt/flink/lib/* /connectors || true
            echo POST COPY; ls -la /connectors || true
            {{- range .Values.flink.connectors }}
            url="{{ . }}"
            name="$(basename $url)"
            echo "Downloading $url -> /connectors/$name"
            tries=0
            until [ $tries -ge 5 ]; do
              if command -v wget >/dev/null 2>&1; then
                wget -q -O /connectors/"$name" "$url" && break || true
              elif command -v curl >/dev/null 2>&1; then
                curl -fsSL -o /connectors/"$name" "$url" && break || true
              else
                echo "No downloader (wget/curl) available"
                break
              fi
              tries=$((tries+1))
              sleep 1
            done
            if [ -s /connectors/"$name" ]; then
              echo "Downloaded $name"
            else
              echo "Failed to download $url"
            fi
            {{- end }}
            echo FINAL; ls -la /connectors || true
            sleep 1
        securityContext:
          runAsUser: 1001970000
        volumeMounts:
        - name: connectors-volume
          mountPath: /connectors

      containers:
      - name: taskmanager
        image: {{ .Values.flink.image }}
        command: ["/bin/bash", "-c"]
        args:
          - |
            /docker-entrypoint.sh taskmanager
        ports:
        - containerPort: 6122
          name: rpc
        env:
        - name: JOB_MANAGER_RPC_ADDRESS
          value: flink-jobmanager
        resources:
          requests:
            memory: {{ .Values.flink.taskmanager.resources.requests.memory | quote }}
            cpu: {{ .Values.flink.taskmanager.resources.requests.cpu | quote }}
          limits:
            memory: {{ .Values.flink.taskmanager.resources.limits.memory | quote }}
            cpu: {{ .Values.flink.taskmanager.resources.limits.cpu | quote }}
        volumeMounts:
        - name: conf-volume
          mountPath: /opt/flink/conf
        - name: recovery-volume
          mountPath: /opt/flink/recovery
        - name: connectors-volume
          mountPath: /opt/flink/lib
      volumes:
      - name: config-volume
        configMap:
          name: flink-config
          items:
          - key: flink-conf.yaml
            path: flink-conf.yaml
      - name: config-src-volume
        configMap:
          name: flink-config
      - name: conf-volume
        emptyDir: {}
      - name: recovery-volume
        emptyDir: {}
      - name: connectors-volume
        emptyDir: {}

---
# ----------------------------------------------------------------------------
# FLINK UI ROUTE (OpenShift)
# ----------------------------------------------------------------------------
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: flink-ui
  labels:
    app: flink
spec:
  to:
    kind: Service
    name: flink-jobmanager
  port:
    targetPort: ui
  tls:
    termination: edge

---
# ----------------------------------------------------------------------------
# SQL JOB SUBMITTER
# ----------------------------------------------------------------------------
apiVersion: batch/v1
kind: Job
metadata:
  name: flink-sql-submit
  labels:
    app: flink
spec:
  backoffLimit: 5
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: flink
        component: sql-submit
    spec:
      initContainers:
      - name: init-config
        image: busybox
        command: ['/bin/sh', '-c']
        args:
          - |
            mkdir -p /opt/flink/conf /opt/flink/lib || true
            chown -R 1001970000:0 /opt/flink/conf /opt/flink/lib || true
            ls -la /opt/flink || true
        securityContext:
          runAsUser: 1001970000
        volumeMounts:
        - name: conf-volume
          mountPath: /opt/flink/conf
        - name: lib-volume
          mountPath: /opt/flink/lib
      restartPolicy: OnFailure
      containers:
      - name: sql-submit
        image: {{ .Values.flink.image }}
        securityContext:
          runAsUser: 1001970000
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            # Download connectors directly
            wget -q -P /opt/flink/lib https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-kafka/1.17.2/flink-sql-connector-kafka-1.17.2.jar || true
            wget -q -P /opt/flink/lib https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc/3.1.0-1.17/flink-connector-jdbc-3.1.0-1.17.jar || true
            wget -q -P /opt/flink/lib https://repo1.maven.org/maven2/org/postgresql/postgresql/42.6.0/postgresql-42.6.0.jar || true

            # Download repo tarball (no git required)
            wget -q -O /tmp/repo.tar.gz https://github.com/atakang7/iot-analytics/archive/refs/heads/main.tar.gz || true
            mkdir -p /repo && tar -xzf /tmp/repo.tar.gz -C /repo --strip-components=2 || true

            # Wait for JobManager
            echo "Waiting for Flink JobManager..."
            until curl -sf http://flink-jobmanager:8081/overview > /dev/null 2>&1; do
              sleep 5
            done
            echo "JobManager ready"

            # Submit SQL jobs (recursive)
            if [ -d /repo/{{ .Values.flink.sqlJobs.path }} ]; then
              find /repo/{{ .Values.flink.sqlJobs.path }} -type f -name '*.sql' -print0 | while IFS= read -r -d '' sql_file; do
                echo "Submitting $sql_file"
                /opt/flink/bin/sql-client.sh -f "$sql_file" || echo "Submit failed: $sql_file"
              done
            else
              echo "No SQL path: /repo/{{ .Values.flink.sqlJobs.path }}"
            fi

            echo "All SQL jobs submitted"
      volumeMounts: []
      volumes:
      - name: conf-volume
        emptyDir: {}
      - name: lib-volume
        emptyDir: {}
{{- end }}
# KEDA ScaledObjects for Analytics Workers
# 
# KEDA (Kubernetes Event-Driven Autoscaling) scales pods based on
# event sources like Kafka consumer lag.
#
# NOTE: KEDA must be installed in the cluster for this to work.
# OpenShift Sandbox doesn't have KEDA, but this config is ready
# for when you move to Oracle Cloud or another cluster.
#
# Install KEDA: https://keda.sh/docs/deploy/

---
# ============================================
# ANOMALY DETECTOR - Scale 0-5 based on lag
# ============================================
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: analytics-anomaly-scaler
  labels:
    app: analytics-anomaly
spec:
  scaleTargetRef:
    name: analytics-anomaly
  pollingInterval: 15
  cooldownPeriod: 60
  minReplicaCount: 0        # Scale to 0 when no lag
  maxReplicaCount: 5
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      consumerGroup: analytics-anomaly
      topic: telemetry
      lagThreshold: "100"   # Scale up when lag > 100
      offsetResetPolicy: latest

---
# ============================================
# AGGREGATOR - Scale 0-3 based on lag
# ============================================
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: analytics-aggregator-scaler
  labels:
    app: analytics-aggregator
spec:
  scaleTargetRef:
    name: analytics-aggregator
  pollingInterval: 15
  cooldownPeriod: 60
  minReplicaCount: 0
  maxReplicaCount: 3
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      consumerGroup: analytics-aggregator
      topic: telemetry
      lagThreshold: "200"
      offsetResetPolicy: latest

---
# ============================================
# ALERTER - Scale 1-3, never scale to 0
# ============================================
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: analytics-alerter-scaler
  labels:
    app: analytics-alerter
spec:
  scaleTargetRef:
    name: analytics-alerter
  pollingInterval: 10       # Check more frequently for alerts
  cooldownPeriod: 30
  minReplicaCount: 1        # Always keep at least 1 for alerts
  maxReplicaCount: 3
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      consumerGroup: analytics-alerter
      topic: telemetry
      lagThreshold: "50"    # Scale up faster for alerts
      offsetResetPolicy: latest

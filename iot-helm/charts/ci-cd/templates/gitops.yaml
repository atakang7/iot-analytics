{{- if .Values.gitops.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitops-config
data:
  GIT_REPO: {{ .Values.gitops.github.repo | quote }}
  POLL_INTERVAL: {{ .Values.gitops.pollInterval | quote }}
  GITHUB_API: "https://api.github.com"
  GITHUB_OWNER: {{ .Values.gitops.github.owner | quote }}
  GITHUB_REPO_NAME: {{ .Values.gitops.github.repoName | quote }}
  JAVA_PATH: {{ .Values.gitops.java.path | default "services" | quote }}
  JAVA_SERVICES: {{ .Values.gitops.java.services | join " " | quote }}
  PYTHON_PATH: {{ .Values.gitops.python.path | default "services/workers" | quote }}
  PYTHON_WORKERS: {{ .Values.gitops.python.workers | join " " | quote }}
  HELM_RELEASE: {{ .Values.gitops.helm.release | default "iot" | quote }}
  HELM_CHART_PATH: {{ .Values.gitops.helm.chartPath | default "iot-helm" | quote }}
  HELM_NAMESPACE: {{ .Release.Namespace | quote }}
  IMAGE_SCAN_ENABLED: {{ .Values.gitops.imageScan.enabled | default "true" | quote }}
  IMAGE_SCAN_FAIL_CRITICAL: {{ .Values.gitops.imageScan.failOnCritical | default "true" | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitops-scripts
data:
  lib.sh: |
{{ .Files.Get "scripts/lib.sh" | indent 4 }}
  controller.sh: |
{{ .Files.Get "scripts/controller.sh" | indent 4 }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitops-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gitops-controller
rules:
  # Helm release tracking (required)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Typical app resources - adjust to what your chart actually deploys
  - apiGroups: [""]
    resources: ["configmaps", "services", "serviceaccounts", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "replicasets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # If your chart creates RBAC
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "rolebindings"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # If using ingress/networking
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # If using HPA
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gitops-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: gitops-controller
subjects:
  - kind: ServiceAccount
    name: gitops-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitops-controller
  labels:
    app: gitops-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitops-controller
  template:
    metadata:
      labels:
        app: gitops-controller
      annotations:
        checksum/script: {{ .Files.Get "scripts/controller.sh" | sha256sum }}
        checksum/config: {{ toJson .Values.gitops | sha256sum }}
    spec:
      serviceAccountName: gitops-controller
      containers:
        - name: controller
          image: {{ .Values.gitops.image | default "alpine/k8s:1.29.0" }}
          command: ["bash", "/scripts/controller.sh"]
          env:
            - name: HOME
              value: /tmp
            - name: GIT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: gitops-secret
                  key: GIT_TOKEN
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: gitops-secret
                  key: SLACK_WEBHOOK
                  optional: true
          envFrom:
            - configMapRef:
                name: gitops-config
          volumeMounts:
            - name: scripts
              mountPath: /scripts
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: "2"
              memory: 2Gi
      volumes:
        - name: scripts
          configMap:
            name: gitops-scripts
            defaultMode: 0755
{{- end }}
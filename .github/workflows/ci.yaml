name: CI

on:
  push:
  pull_request:

jobs:
  detect:
    uses: ./.github/workflows/detect-changes.yaml

  java:
    needs: detect
    if: needs.detect.outputs.java_changed == 'true'
    uses: ./.github/workflows/java-ci.yaml
    with:
      services: ${{ needs.detect.outputs.java_services }}

  python:
    needs: detect
    if: needs.detect.outputs.python_changed == 'true'
    uses: ./.github/workflows/python-ci.yaml
    with:
      workers: ${{ needs.detect.outputs.python_workers }}

  handoff-to-cd:
    needs: [detect, java, python]
    if: always() && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Set pending deploy status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'pending',
              context: 'deploy/cd',
              description: 'Waiting for CD controller...'
            });
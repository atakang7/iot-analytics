# .github/workflows/ci.yaml
# Main CI workflow - runs tests on PR and push
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────
  # Detect what changed
  # ─────────────────────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.services }}
      workers: ${{ steps.filter.outputs.workers }}
      services-list: ${{ steps.filter.outputs.services_files }}
      workers-list: ${{ steps.filter.outputs.workers_files }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            services:
              - 'services/**'
            workers:
              - 'workers/**'

  # ─────────────────────────────────────────────
  # Test Java services
  # ─────────────────────────────────────────────
  test-ingestion:
    needs: changes
    if: needs.changes.outputs.services == 'true'
    uses: ./.github/workflows/_test-java.yaml
    with:
      name: ingestion
      path: services/ingestion

  test-device-registry:
    needs: changes
    if: needs.changes.outputs.services == 'true'
    uses: ./.github/workflows/_test-java.yaml
    with:
      name: device-registry
      path: services/device-registry

  # ─────────────────────────────────────────────
  # Test Python workers
  # ─────────────────────────────────────────────
  test-telemetry-worker:
    needs: changes
    if: needs.changes.outputs.workers == 'true'
    uses: ./.github/workflows/_test-python.yaml
    with:
      name: telemetry-worker
      path: workers/telemetry-worker

  test-stream-worker:
    needs: changes
    if: needs.changes.outputs.workers == 'true'
    uses: ./.github/workflows/_test-python.yaml
    with:
      name: stream-worker
      path: workers/stream-worker

  test-alert-worker:
    needs: changes
    if: needs.changes.outputs.workers == 'true'
    uses: ./.github/workflows/_test-python.yaml
    with:
      name: alert-worker
      path: workers/alert-worker

  # ─────────────────────────────────────────────
  # Summary
  # ─────────────────────────────────────────────
  ci-success:
    runs-on: ubuntu-latest
    needs: 
      - test-ingestion
      - test-device-registry
      - test-telemetry-worker
      - test-stream-worker
      - test-alert-worker
    if: always()
    steps:
      - name: Check results
        run: |
          results="${{ needs.test-ingestion.result }},${{ needs.test-device-registry.result }},${{ needs.test-telemetry-worker.result }},${{ needs.test-stream-worker.result }},${{ needs.test-alert-worker.result }}"
          if echo "$results" | grep -q "failure"; then
            echo "::error::Some tests failed"
            exit 1
          fi
          echo "All tests passed or skipped"

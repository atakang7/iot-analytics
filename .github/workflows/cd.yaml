# .github/workflows/cd.yaml
# Main CD workflow - deploys to OpenShift
name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to deploy'
        required: true
        type: choice
        options:
          - all
          - ingestion
          - device-registry
          - telemetry-worker
          - stream-worker
          - alert-worker
          - infrastructure
      force:
        description: 'Force deploy (skip change detection)'
        type: boolean
        default: false

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect changes
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    runs-on: ubuntu-latest
    outputs:
      ingestion: ${{ steps.check.outputs.ingestion }}
      device-registry: ${{ steps.check.outputs.device-registry }}
      telemetry-worker: ${{ steps.check.outputs.telemetry-worker }}
      stream-worker: ${{ steps.check.outputs.stream-worker }}
      alert-worker: ${{ steps.check.outputs.alert-worker }}
      infrastructure: ${{ steps.check.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changes
        id: check
        run: |
          # Manual trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            COMPONENT="${{ inputs.component }}"
            FORCE="${{ inputs.force }}"
            
            if [[ "$COMPONENT" == "all" ]] || [[ "$FORCE" == "true" ]]; then
              echo "ingestion=true" >> $GITHUB_OUTPUT
              echo "device-registry=true" >> $GITHUB_OUTPUT
              echo "telemetry-worker=true" >> $GITHUB_OUTPUT
              echo "stream-worker=true" >> $GITHUB_OUTPUT
              echo "alert-worker=true" >> $GITHUB_OUTPUT
              echo "infrastructure=true" >> $GITHUB_OUTPUT
            else
              echo "$COMPONENT=true" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi
          
          # Auto-detect from git diff
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          echo "Changed files:"
          echo "$CHANGED"
          
          echo "$CHANGED" | grep -q "^services/ingestion/" && echo "ingestion=true" >> $GITHUB_OUTPUT || true
          echo "$CHANGED" | grep -q "^services/device-registry/" && echo "device-registry=true" >> $GITHUB_OUTPUT || true
          echo "$CHANGED" | grep -q "^workers/telemetry-worker/" && echo "telemetry-worker=true" >> $GITHUB_OUTPUT || true
          echo "$CHANGED" | grep -q "^workers/stream-worker/" && echo "stream-worker=true" >> $GITHUB_OUTPUT || true
          echo "$CHANGED" | grep -q "^workers/alert-worker/" && echo "alert-worker=true" >> $GITHUB_OUTPUT || true
          echo "$CHANGED" | grep -qE "^helm/|^Chart.yaml|^values.yaml" && echo "infrastructure=true" >> $GITHUB_OUTPUT || true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Java Services
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-ingestion:
    needs: changes
    if: needs.changes.outputs.ingestion == 'true'
    uses: ./.github/workflows/_build-deploy.yaml
    with:
      name: ingestion
      path: services/ingestion
    secrets:
      OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}

  deploy-device-registry:
    needs: changes
    if: needs.changes.outputs.device-registry == 'true'
    uses: ./.github/workflows/_build-deploy.yaml
    with:
      name: device-registry
      path: services/device-registry
    secrets:
      OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Python Workers
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-telemetry-worker:
    needs: changes
    if: needs.changes.outputs.telemetry-worker == 'true'
    uses: ./.github/workflows/_build-deploy.yaml
    with:
      name: telemetry-worker
      path: workers/telemetry-worker
    secrets:
      OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}

  deploy-stream-worker:
    needs: changes
    if: needs.changes.outputs.stream-worker == 'true'
    uses: ./.github/workflows/_build-deploy.yaml
    with:
      name: stream-worker
      path: workers/stream-worker
    secrets:
      OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}

  deploy-alert-worker:
    needs: changes
    if: needs.changes.outputs.alert-worker == 'true'
    uses: ./.github/workflows/_build-deploy.yaml
    with:
      name: alert-worker
      path: workers/alert-worker
    secrets:
      OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Infrastructure (Helm)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-infrastructure:
    needs: changes
    if: needs.changes.outputs.infrastructure == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OpenShift CLI
        uses: ./.github/actions/setup-oc
        with:
          server: ${{ secrets.OPENSHIFT_SERVER }}
          token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}

      - name: Install Helm
        run: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Deploy Helm chart
        run: |
          helm upgrade --install iot-analytics . \
            --namespace ${{ secrets.OPENSHIFT_NAMESPACE }} \
            --wait --timeout 10m

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    runs-on: ubuntu-latest
    needs:
      - deploy-ingestion
      - deploy-device-registry
      - deploy-telemetry-worker
      - deploy-stream-worker
      - deploy-alert-worker
      - deploy-infrastructure
    if: always()
    steps:
      - name: Setup OpenShift CLI
        if: always()
        uses: ./.github/actions/setup-oc
        with:
          server: ${{ secrets.OPENSHIFT_SERVER }}
          token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ingestion | ${{ needs.deploy-ingestion.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| device-registry | ${{ needs.deploy-device-registry.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| telemetry-worker | ${{ needs.deploy-telemetry-worker.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| stream-worker | ${{ needs.deploy-stream-worker.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| alert-worker | ${{ needs.deploy-alert-worker.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| infrastructure | ${{ needs.deploy-infrastructure.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Cluster status
        if: always()
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          oc get pods --no-headers 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "Could not fetch pod status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
